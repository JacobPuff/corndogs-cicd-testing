# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Go Build and Test
on:
  pull_request:
    types: [opened, reopened, synchronize, edited]
    branches: [ main ]

jobs:
  pr_name_check:
    name: Validate PR Name Expectations
    runs-on: ubuntu-latest
    steps:
    - name: Check PR name
      if: |
        !contains(github.event.pull_request.title, 'patch-') &&
        !contains(github.event.pull_request.title, 'minor-') &&
        !contains(github.event.pull_request.title, 'major-')
      run: |
        echo "PR Name must begin with 'patch-' 'minor-' or 'major-'"
        exit 1
    - name: Check PR name
      if: |
        contains(github.event.pull_request.title, 'patch-') ||
        contains(github.event.pull_request.title, 'minor-') ||
        contains(github.event.pull_request.title, 'major-')
      run: |
        echo "PR Name meets expectations"
        exit 0
  pipeline:
    name: Build and Test with Skaffold Integration
    runs-on: ubuntu-latest
    needs:
      - pr_name_check
    steps:
    - uses: actions/checkout@v2
    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.17
    - name: Install Protoc
      uses: arduino/setup-protoc@v1
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
    - name: Install Kind
      run: |
        GO111MODULE=on go get sigs.k8s.io/kind
    - name: Install buf
      uses: bufbuild/buf-setup-action@v0.6.0
      with:
        version: '1.0.0-rc8'
    - name: Buf lint
      uses: bufbuild/buf-lint-action@v1
    - name: Install helm
      uses: azure/setup-helm@v1
      with:
        version: v3.7.1
    - name: Update helm chart dependencies
      run: |
        helm dependency update chart
    - name: Buf generate
      run: |
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
        export PATH="$PATH:$(go env GOPATH)/bin"
        npm install grpc-tools grpc_tools_node_protoc_ts --global
        buf generate
    - name: Create Kind cluster
      run: |
        PATH=$(go env GOPATH)/bin:$PATH kind create cluster
    - name: Run skaffold
      uses: hiberbee/github-action-skaffold@1.12.0
      with:
        skaffold-version: 1.34.0
        command: run
    - name: Run tests
      run: |
        kubectl -n skaffoldcorndogs port-forward svc/corndogs 5080 &
        go test -v ./...

